import { useState, useEffect } from 'react';
import { ModelManager } from '../lib/modelManager';

export default function ModelVersionControl({ dataManager }) {
  const [versions, setVersions] = useState([]);
    const [selectedVersions, setSelectedVersions] = useState([null, null]);
      const [comparisonResult, setComparisonResult] = useState(null);
        const [newVersionDesc, setNewVersionDesc] = useState('');
          
            const modelManager = new ModelManager();

              useEffect(() => {
                  setVersions(modelManager.modelVersions);
                    }, []);

                      const saveNewVersion = async () => {
                          const model = await createModel();
                              const { normalizedData, labels } = dataManager.normalizeData();
                                  
                                      const trainingResult = await trainModel(model, normalizedData, labels);
                                          
                                              const versionInfo = await modelManager.saveModel(model, {
                                                    description: newVersionDesc,
                                                          trainingDataSize: dataManager.trainingData.length,
                                                                metrics: {
                                                                        accuracy: trainingResult.history.acc[trainingResult.history.acc.length - 1],
                                                                                loss: trainingResult.history.loss[trainingResult.history.loss.length - 1]
                                                                                      }
                                                                                          });
                                                                                              
                                                                                                  setVersions([...modelManager.modelVersions]);
                                                                                                      setNewVersionDesc('');
                                                                                                        };

                                                                                                          const compareVersions = async () => {
                                                                                                              if (!selectedVersions[0] || !selectedVersions[1]) return;
                                                                                                                  
                                                                                                                      const testData = {
                                                                                                                            xs: tf.tensor2d(dataManager.trainingData.slice(0, 10)),
                                                                                                                                  ys: tf.tensor2d(dataManager.trainingLabels.slice(0, 10))
                                                                                                                                      };
                                                                                                                                          
                                                                                                                                              const result = await modelManager.compareModels(
                                                                                                                                                    selectedVersions[0],
                                                                                                                                                          selectedVersions[1],
                                                                                                                                                                testData
                                                                                                                                                                    );
                                                                                                                                                                        
                                                                                                                                                                            setComparisonResult(result);
                                                                                                                                                                              };

                                                                                                                                                                                const deployVersion = (versionId) => {
                                                                                                                                                                                    modelManager.setProductionVersion(versionId);
                                                                                                                                                                                        setVersions([...modelManager.modelVersions]);
                                                                                                                                                                                            alert(`Version ${versionId} deployed to production!`);
                                                                                                                                                                                              };

                                                                                                                                                                                                return (
                                                                                                                                                                                                    <div className="version-control">
                                                                                                                                                                                                          <h2>Model Version Control</h2>
                                                                                                                                                                                                                
                                                                                                                                                                                                                      <div className="save-version">
                                                                                                                                                                                                                              <input
                                                                                                                                                                                                                                        type="text"
                                                                                                                                                                                                                                                  value={newVersionDesc}
                                                                                                                                                                                                                                                            onChange={(e) => setNewVersionDesc(e.target.value)}
                                                                                                                                                                                                                                                                      placeholder="Version description"
                                                                                                                                                                                                                                                                              />
                                                                                                                                                                                                                                                                                      <button onClick={saveNewVersion} disabled={dataManager.trainingData.length === 0}>
                                                                                                                                                                                                                                                                                                Save New Version
                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                          <div className="version-comparison">
                                                                                                                                                                                                                                                                                                                                  <h3>Compare Versions</h3>
                                                                                                                                                                                                                                                                                                                                          <div className="version-selectors">
                                                                                                                                                                                                                                                                                                                                                    {[0, 1].map((i) => (
                                                                                                                                                                                                                                                                                                                                                                <select
                                                                                                                                                                                                                                                                                                                                                                              key={i}
                                                                                                                                                                                                                                                                                                                                                                                            value={selectedVersions[i] || ''}
                                                                                                                                                                                                                                                                                                                                                                                                          onChange={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                          const newSelected = [...selectedVersions];
                                                                                                                                                                                                                                                                                                                                                                                                                                          newSelected[i] = e.target.value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                          setSelectedVersions(newSelected);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <option value="">Select version...</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {versions.map((v) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <option key={v.id} value={v.id}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {v.description} ({new Date(v.timestamp).toLocaleDateString()})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </select>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <button onClick={compareVersions} disabled={!selectedVersions[0] || !selectedVersions[1]}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Compare Selected
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {comparisonResult && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="comparison-results">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <h4>Comparison Results</h4>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <th>Metric</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <th>Version {selectedVersions[0].slice(0, 6)}</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <th>Version {selectedVersions[1].slice(0, 6)}</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td>Accuracy</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <td>{(comparisonResult[selectedVersions[0]].accuracy * 100).toFixed(1)}%</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <td>{(comparisonResult[selectedVersions[1]].accuracy * 100).toFixed(1)}%</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <td>Prediction Time</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td>{comparisonResult[selectedVersions[0]].predictionTime.toFixed(2)}ms</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{comparisonResult[selectedVersions[1]].predictionTime.toFixed(2)}ms</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="version-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h3>Version History</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <th>ID</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <th>Description</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <th>Date</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <th>Accuracy</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <th>Data Size</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <th>Status</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <th>Actions</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {versions.map((v) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <tr key={v.id}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{v.id.slice(0, 6)}...</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{v.description}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{new Date(v.timestamp).toLocaleDateString()}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{(v.metrics.accuracy * 100)?.toFixed(1)}%</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{v.trainingDataSize}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>{v.isProduction ? ' Production' : ' Staging'}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {!v.isProduction && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button onClick={() => deployVersion(v.id)}>Deploy</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }